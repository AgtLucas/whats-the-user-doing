<html>
  <head>
    <meta name="viewport" content="width=device-width">
    <meta name="viewport" content="initial-scale=1.0">
  </head>
  <body>
    <h1>What's the user doing?</h1>

    <p>Chances are high, you are <b><span id="userDoing"></span></b></p>

    <h3>Motion</h3>
    <p>X: <span id="motionX">0</span></p>
    <p>Y: <span id="motionY">0</span></p>
    <p>Z: <span id="motionZ">0</span></p>
    <p>Overall: <span id="motionOverall">0</span></p>

    <h3>Orientation</h3>
    <p>X: <span id="orientationX">0</span></p>
    <p>Y: <span id="orientationY">0</span></p>
    <p>Z: <span id="orientationZ">0</span></p>
  </body>
</html>

<script type="text/javascript">
  // via https://stackoverflow.com/questions/9050345/
  if (!Array.prototype.last) {
    Array.prototype.last = function() {
      return this[this.length - 1];
  };

  var historicMotion = {
    "x": [],
    "y": [],
    "z": []
  }
  var historicOrientation = {
    "x": [],
    "y": [],
    "z": []
  }

  function setStatus(status) {
    document.getElementById("userDoing").textContent = status
  }

  function updateStatus() {
    let movement = mostRecentMovementOverall(75)
    document.getElementById("motionOverall").textContent = Math.round(movement * 100) / 100

    if (mostRecentMovementOverall(1000) > 60) { // TODO: haven't tested this, 1,000 so it's a longer time
      setStatus("driving")
    } else if (historicOrientation["z"].last() > 70 || historicOrientation["z"].last() < -70) {
      setStatus("lying in bed sideways")
    } else if (historicOrientation["y"].last() > 160 || historicOrientation["y"].last() < -160) {
      setStatus("lying on your back, with your phone up")
    } else if (historicOrientation["y"].last() >= 30 && historicOrientation["y"].last() < 70) {
      if (movement > 18) {
        setStatus("using your phone while walking or driving")
      } else {
        setStatus("using your phone, sitting or standing")
      }
    } else if (historicOrientation["y"].last() >= 70 && historicOrientation["y"].last() < 95) {
      setStatus("taking a picture")
    } else if (historicOrientation["y"].last() >= 95 && historicOrientation["y"].last() < 120) {
      setStatus("taking a selfie")
    } else {
      setStatus("using your phone")
    }
  }


  function mostRecentMovementOverall(numberOfHistoricPoints) {
    return (mostRecentMovement(historicMotion["x"], numberOfHistoricPoints, true) + 
            mostRecentMovement(historicMotion["y"], numberOfHistoricPoints, true) + 
            mostRecentMovement(historicMotion["z"], numberOfHistoricPoints, true)) / 3.0
  }

  // numberOfHistoricPoints: 100 is about 3 seconds
  function mostRecentMovement(array, numberOfHistoricPoints, removeNegatives) {
    if (array.length > numberOfHistoricPoints) {
      totalSum = 0
      for (var toCount = 0; toCount < numberOfHistoricPoints; toCount++) {
        currentElement = array[array.length - toCount - 1]
        currentElement *= (1 - toCount / numberOfHistoricPoints) // weight the most recent data more
        if (currentElement < 0 && removeNegatives) currentElement = currentElement * -1 
        if (currentElement > 0.1 || currentElement < -0.1) totalSum += currentElement
      }
      return totalSum * 100 / numberOfHistoricPoints
    }
    return 0 // not enough data yet
  }


  setInterval(updateStatus, 100)
  updateStatus()


  // Tracking
  if (window.DeviceMotionEvent) {
    window.addEventListener("devicemotion", motion, false);
  } else {
    console.log("DeviceMotionEvent is not supported");
  }

  function motion(event) {
    document.getElementById("motionX").textContent = Math.round(mostRecentMovement(historicMotion["x"], 150, false) * 100) / 100
    document.getElementById("motionY").textContent = Math.round(mostRecentMovement(historicMotion["y"], 150, false) * 100) / 100
    document.getElementById("motionZ").textContent = Math.round(mostRecentMovement(historicMotion["z"], 150, false) * 100) / 100

    historicMotion["x"].push(event.acceleration.x)
    historicMotion["y"].push(event.acceleration.y)
    historicMotion["z"].push(event.acceleration.z)
  }

  if (window.DeviceOrientationEvent) {
    window.addEventListener("deviceorientation", orientation, false);
  } else {
    console.log("DeviceOrientationEvent is not supported");
  }

  function orientation(event) {
    document.getElementById("orientationX").textContent = Math.round(event.alpha)
    document.getElementById("orientationY").textContent = Math.round(event.beta)
    document.getElementById("orientationZ").textContent = Math.round(event.gamma)

    historicOrientation["x"].push(event.alpha)
    historicOrientation["y"].push(event.beta)
    historicOrientation["z"].push(event.gamma)
  }
};
</script>